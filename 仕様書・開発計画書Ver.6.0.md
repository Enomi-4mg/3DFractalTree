# **3Dフラクタル成長シミュレーター 開発計画書 Ver.7.0 (openFrameworks版)**

## **1\. プロジェクト概要**

本作品は、C++およびopenFrameworksを用いた3Dフラクタル構造の動的生成シミュレーターである。頂点バッファオブジェクト（VBO）を用いた描画最適化、自動追従カメラ、および天候・ライティングシステムを統合している。

## **2\. システム構成 (Architecture)**

* **開発環境**: Visual Studio 2022 / openFrameworks v0.12.1

* **主要クラス**:
  * **ofApp**: メインループ、入力管理、カメラ制御（自動追従/手動切替）、照明制御を担当。 
  * **Tree**: フラクタル再帰ロジック、成長アルゴリズム、パラメータ補間、メッシュ生成（五角柱）、装飾（花・葉）の描画。  
  * **Weather**: 天候状態（SUNNY, RAINY, MOONLIGHT）の管理、背景色・成長バフの提供。 2Dスクリーン空間における雨線の描画、背景色。 
  * **Ground**: 平原の描画。

## **3\. 実装済みの主要機能**

### **3.1 育成・コマンドシステム**

* **描画・最適化**
  1. **VBO集約**: 枝（五角柱）、花（球体）、葉（菱形メッシュ）の全頂点データを一つのofVboMeshに格納し、ドローコールを1回に抑制。

  2. **法線計算**: 頂点ごとに法線（Normal）を設定。ofLightによる平行光源（SUNNY）および点光源（MOONLIGHT）の陰影計算に対応。

  3. **形状歪み**: bMutation > 0.9 の際、ofSignedNoiseを用いて枝の頂点座標を時間経過に従い変位させる。

* **3つのコマンド**:  
  1. **Water**: 長さを伸ばし、カオス度を下げる。  
  2. **Fertilizer**: 太さを増し、カオス度を下げる。  
  3. **Kotodama**: カオス度（Mutation）を上げ、色彩を変異させる。
  
* **成長ブースト**: 日数（1〜30日）に従い、成長効率が1.0倍から2.5倍へ線形増加。  

* **開花フラグ**: すべてのパラメータは目標値に向かって毎フレーム滑らかに変化。

* **天候連動**: 天候とコマンドが一致した場合（例：SUNNY \+ Water）、さらに1.5倍の補正。  

* **線形補間 (Lerp)**: すべてのパラメータは目標値に向かって毎フレーム滑らかに変化。

### **3.2 ビジュアル・空間演出**

* **動的色彩**: HSB色空間を用い、カオス度に応じて色彩変異の幅が増大。  
* **通常カメラ**: 木の全高に基づき、距離（Distance）と注視点（Target）を自動計算。Y軸周りの定速回転。
* **View Mode**: 'V'キーでHUDを消し、マウスによる自由な視点操作を可能にする。
* **2Dオーバーレイ**:天候（RAINY）時の雨線は、3Dカメラの外側（スクリーン空間）で2Dラインとして描画。

## **4\. 現在のパラメータ・バランス**

* **分岐条件**: 枝の長さ40ユニットごとに再帰深度（Depth）が1増加（最大8）。  
* **分岐数**: 描画負荷軽減のため、先端付近（Depth \< 2）は2本、それ以外は3本に分岐。  
* **開花条件**: カオス度（bMutation）が0.4を超え、かつ先端の枝がある程度の長さを持つ場合。

## **5\. 次のステップ (Roadmap)**

* **カオス表現の強化**: カオス度最大時に ofNoise を用いて枝の頂点を歪ませる「形状の崩壊」の実装。  
* **天候エフェクト**: RAINY時の雨パーティクル（線描画）の実装。  
* **最適化**: 枝の描画を ofVboMesh に集約し、数千本の枝を安定して描画可能にする。

## **作業環境・その他**

### **環境構築**: Windows 11 / Visual Studio 2022 / openFrameworks v0.12.0 の環境でビルドを確認。