# **3Dフラクタル成長シミュレーター 開発計画書 Ver.8.0**

## **1\. プロジェクト概要**

C++およびopenFrameworksを用いた、フラクタル構造の動的生成および成長シミュレーター。外部設定ファイル（JSON）によるパラメータ管理、VBOを用いた描画最適化、累進的経験値システムを特徴とする。

## **2\. システム構成 (Architecture)**

* **開発環境**: Visual Studio 2022 / openFrameworks v0.12.1

* **データ管理**: `settings.json`による定数の外部保持（読み込み失敗時のフォールバック機能付き）。

* **主要クラス**:
  * **ofApp**: メインループ、入力管理、カメラ制御（自動追従/手動切替）、照明制御を担当。 
  * **Tree**: フラクタル再帰計算、メッシュ生成、成長ロジック（Exp/Lv制）、パラメータ補間（Lerp）を担当。
  * **Weather**: 天候状態（SUNNY, RAINY, MOONLIGHT）の管理、背景色・バフ計算、2Dエフェクトを担当。
  * **Ground**: 平原の描画。
  * **Particle**: インスタンス化されたパーティクルの移動・描画ロジック。

## **3\. 実装済みの主要機能**

### **3.1 成長システム**

* **経験値・レベル（深さ）管理**:
  * 木の「長さ（bLen）」と「太さ（bThick）」を独立した経験値として管理。
  * 枝の再帰深度（Depth）は、太さ（bThick）が指定の累積しきい値を超えた際に増加する。
  * しきい値計算式: $base \times depth^{power}$ （指数関数的な累進性）。

* **シームレス・アニメーション**:
  * 各パラメータは`lerp`により毎フレーム目標値へ補間される。
  * パラメータが一定以上の変化量を持つ期間のみ、`ofVboMesh`のクリアおよび再構築を実行し、CPU負荷を抑制。

* **コマンドと増分**:
  * **Water**: 長さ（bLen）を増大させ、変異度（bMutation）を低下させる。
  * **Fertilizer**: 太さ（bThick）を増大させ、変異度（bMutation）を低下させる。
  * **Kotodama**: 変異度（bMutation）を増大させる。

* **描画・最適化**
  1. **VBO集約**: 枝（五角柱）、花（球体）、葉（菱形メッシュ）の全頂点データを一つのofVboMeshに格納し、ドローコールを1回に抑制。

  2. **法線計算**: 頂点ごとに法線（Normal）を設定。ofLightによる平行光源（SUNNY）および点光源（MOONLIGHT）の陰影計算に対応。

  3. **形状歪み**: bMutation > 0.9 の際、ofSignedNoiseを用いて枝の頂点座標を時間経過に従い変位させる。

* **3つのコマンド**:  
  1. **Water**: 長さを伸ばし、カオス度を下げる。  
  2. **Fertilizer**: 太さを増し、カオス度を下げる。  
  3. **Kotodama**: カオス度（Mutation）を上げ、色彩を変異させる。

### **3.2 グラフィックス・最適化**

* **VBO集約とLOD**:
  * 枝、葉、花を単一の ofVboMesh に集約。
  * 再帰深度が浅い（先端部）は三角柱、深い（根元部）は五角柱として描画し、ポリゴン数を削減。
* **形状変位**:
  * 変異度（bMutation）が0.9を超えた際、`sofSignedNoise`を用いて頂点座標を時間依存で変位させる。
* **カメラ制御**:
  * 木の推定全高に基づき、注視点（Target）と距離（Distance）を自動計算し補間移動。
  * `settings.json`より回転速度、追従感度の調整が可能。

### **3.3 UI・デバッグ**
* **HUD表示**:
  * Bitmapテキストの背景に半透明（Alpha 120）の黒色矩形を配置し、視認性を確保。
  * `Tree`クラスから取得した進捗率に基づき、次のDepthまでの経験値バーを描画。
* **デバッグモード**:
  * 'D'キーにより切り替え。FPS、累積経験値、変異度の生データを画面端に表示。

## **4\. 外部設定ファイル (settings.json) 仕様**
* **tree**: 最大深度、経験値ベース値/指数、描画スケール、分岐角、各種色彩（RGB/HSB）。
* **camera**: 回転速度、補間速度、最小距離、高さ係数。
* **weather**: 各天候の背景色。
* **game**: 最大日数、スキルポイント付与間隔、コマンドごとの基礎増分値。

## **5\. 次のステップ (Roadmap)**
* **演出強化**: 成長完了時（50日目）のカメラシーケンスの実装。
* **サウンド**: 成長段階や変異度に応じた動的な音響生成。
* **UI改善**: スキルツリーの視覚化およびインタラクションの強化。