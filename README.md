# **3Dフラクタル成長シミュレーター 仕様書 Ver.9.0**

## **1\. プロジェクト概要**

C++およびopenFrameworks v0.12.1を用いた、フラクタル構造の動的生成および成長シミュレーター。VBOによる描画最適化、外部JSONによる定数管理、および専用のGUIシステムを備える。

## **2\. 操作方法**

### **メイン操作 (GUI / マウス)**

* **下部アクションバー**: 育成コマンド（WATER, FERTILIZE, KOTODAMA）の実行。  
* **右側成長スロット**: スキルアップグレード（GROWTH, RESIST, CATALYST）の実行。  
* **クールタイム**: コマンド実行後、settings.json で指定された秒数（デフォルト1.0s）は操作がロックされる。

### **キーボードショートカット**

| Key | 機能 |
| :---- | :---- |
| 1, 2, 3 | 育成コマンド (Water, Fertilizer, Kotodama) |
| V | View Mode (カメラ自由操作) の切り替え |
| D | デバッグ情報の表示/非表示切り替え |
| R | システムの全初期化 (Reset) |
| **(Debug Mode)** | **DキーがONの時のみ有効** |
| T | 日数を5日分進め、進化判定を強制実行 |
| E | 成長タイプをサイクル切り替え (DEFAULT \-\> ELEGANT \-\> STURDY \-\> ELDRITCH) |
| F | 花の形状をサイクル切り替え (NONE \-\> CRYSTAL \-\> PETAL \-\> SPIRIT) |
| P | スキルポイント無限化 (99ポイント固定) のトグル |
| Space | 時間（日数）の進行停止トグル |
| \+ / \= | 経験値を50ポイント加算 (レベルアップ演出のテスト用) |

## **3\. 技術仕様・システム構成**

### **3.1 描画エンジン (Tree クラス)**

* **VBOインデックス描画**: 枝、葉、花を単一の ofVboMesh に集約。  
* **枝の形状**: 1本の枝を縦方向に4分割（5断面）し、twistFactor によるねじれとテーパリングを実装。  
* **LOD制御**: 再帰深度に基づき、断面の頂点数を 3〜5 に動的調整。

### **3.2 UI・演出システム (ofApp クラス)**

* **二段構えプログレスバー**: 経験値が100%に達した際、「発光保持 (0.4s)」を経てからリセットされるアニメーションを実装。  
* **進化勲章システム**: 画面左側に進化状態を記号（◇:ELEGANT, □:STURDY, ◎:ELDRITCH, ✿:BLOOM）で表示。達成時にタイプ別のイメージカラーで点灯。  
* **オーラ演出**: OF\_BLENDMODE\_ADD を用いた色加算描画。スキルアップ時に木の根元から上空へ向けて、鋭い直線状の光芒（AuraBeam）を生成・明滅させる。  
* **レスポンシブ配置**: getUIScale() により、解像度 1024x768 を基準とした自動スケーリングを適用。

### **3.3 データ管理構造**

* **Constants.h**: 全データ構造 (GameState, UISettings, AuraBeam 等) および列挙型を単一ファイルに集約。  
* **settings.json**: 木の物理パラメータ、カメラ設定、天候背景色、UI座標、ボタン色、オーラ演出定数を外部保持。
## **3\. 技術仕様・主要機能**

### **3.4 成長システム**

* **進化分岐**: Day 20 (樹形分岐), Day 40 (開花分岐)。  
* **スキルバフ**: Resilience による副作用軽減、Catalyst による開花しきい値の緩和。  
* **デバッグHUD**: 画面左側のゲームUIの上に、FPS、頂点数、経験値詳細等のスタッツを透過重ね表示。

* **コマンドと増分・トレードオフ**:
  * **Water**: `depthExp`+, `長さ`++, `太さ`-, `変異度`--
  * **Fertilizer**: `depthExp`+, `長さ`-, `太さ`++, `変異度`-
  * **Kotodama**: `depthExp`++, `長さ`+, `太さ`-, `変異度`++

* **描画・最適化**
  * **縦方向分割 (Subdivision)**: 1つの枝を縦方向に4分割（5つの断面）して生成。ねじれ (Twist) / テーパリングを表現。
  * **法線計算**: 頂点ごとに法線（Normal）を設定。`ofLight`による平行光源（SUNNY）および点光源（MOONLIGHT）の陰影計算に対応。
  * **カメラ制御**:
    * 木の推定全高に基づき、注視点（Target）と距離（Distance）を自動計算し補間移動。
    * `settings.json`より回転速度、追従感度の調整が可能。

### **3.3 UI・視覚演出**
* **パラメータバー**: 現在値と最大値（Memory）を一つのバーに重ねて表示。
* **レスポンシブUI**: 基準解像度（1024x768）に対するウィンドウサイズ比率に基づきHUDを自動スケール。
* **3D/2Dパーティクル**:3D/2Dパーティクル: 育成、天候、および進化発生時にそれぞれ独立した物理挙動を持つパーティクルを生成。

## **4\. 外部設定ファイル (settings.json) 仕様**
* **tree**: 最大深度、経験値ベース値/指数、描画スケール、分岐角、各種色彩（RGB/HSB）。
* **camera**: 回転速度、補間速度、最小距離、高さ係数。
* **weather**: 各天候の背景色。
* **game**: 最大日数、スキルポイント付与間隔、コマンドごとの基礎増分値。

## **5\. 次のステップ (Roadmap)**
* **パフォーマンス**: 再帰深度が深い際のメッシュ再構築負荷。1フレームでの全更新を避ける「分割構築（Time-Slicing）」の導入を検討。  
* **ビジュアル**: 枝の接続部のさらなる平滑化。
* **UI改善**: 直感的な操作などインタラクションの強化。