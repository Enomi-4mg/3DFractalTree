# **3Dフラクタル成長シミュレーター 開発計画書 Ver.8.5**

## **1\. プロジェクト概要**

C++およびopenFrameworksを用いた、フラクタル構造の動的生成および成長シミュレーター。外部設定ファイル（JSON）によるパラメータ管理、VBOを用いた描画最適化、累進的経験値システムを特徴とする。

## **操作方法**

| button | 操作 |
| ------ | --- |
|1, 2, 3 | 育成コマンド実行 |
| V | View Mode (カメラ自由操作) 切替 |
| D | 詳細デバッグ情報の表示切替 |
| R | シミュレーターの全初期化 |
| T (Debug) | 日数を5日分進め、進化判定を実行 |
| E (Debug) | 成長タイプを「TYPE_ELDRITCH」へ強制変更 |
| F (Debug) | 花の形状を「FLOWER_SPIRIT」へ強制変更 |
| W (Debug) | 天候（Weather）切替（デバッグ用） |

## **2\. システム構成 (Architecture)**

* **開発環境**: Visual Studio 2022 / openFrameworks v0.12.1

* **外部依存**: ofxGui (標準アドオン)、verdana.ttf (フォントファイル)

* **データ管理**: `settings.json`による定数の外部保持（読み込み失敗時のフォールバック機能付き）。

* **主要クラス**:
  * **ofApp**: メインループ、入力管理、カメラ制御（自動追従/手動切替）、照明制御を担当、パーティクル寿命管理。 
  * **Tree**: フラクタル再帰計算（VBO構築）s、メッシュ生成、成長ロジック（Exp/Lv制）、パラメータ補間（Lerp）を担当。
  * **Weather**: 天候状態（SUNNY, RAINY, MOONLIGHT）の管理、背景色・バフ計算、2Dエフェクトを担当。
  * **Ground**: 平原の描画。
  * **Particle / Particle2D**: インスタンス化されたパーティクルの移動・描画ロジック。

## **3\. 技術仕様・主要機能**

### **3.1 成長システム**

* **経験値・レベル（深さ）管理**:
  * 木の「長さ（bLen）」と「太さ（bThick）」を独立した経験値として管理。
  * 枝の再帰深度（Depth）は、太さ（bThick）が指定の累積しきい値を超えた際に増加する。
  * しきい値計算式: $base \times depth^{power}$ （指数関数的な累進性）。

* **進化システム（不可逆分岐）**
  * **Day 20（成長タイプ分岐）**: 累積された長さ、太さ、変異度のうち最大の値に応じて「ELEGANT」「STURDY」「ELDRITCH」のいずれかに固定。
  * **Day 40（花の形状分岐）**: 成長タイプに応じて「CRYSTAL（結晶）」「PETAL（花弁）」「SPIRIT（霊魂）」の形状へ変化。

* **シームレス・アニメーション**:
  * 各パラメータは`lerp`により毎フレーム目標値へ補間される。
  * パラメータが一定以上の変化量を持つ期間のみ、`ofVboMesh`のクリアおよび再構築を実行し、CPU負荷を抑制。

* **コマンドと増分・トレードオフ**:
  * **Water**: `depthExp`+, `長さ`++, `太さ`-, `変異度`--
  * **Fertilizer**: `depthExp`+, `長さ`-, `太さ`++, `変異度`-
  * **Kotodama**: `depthExp`++, `長さ`+, `太さ`-, `変異度`++

* **描画・最適化**
  * **VBO集約**: 枝（五角柱/三角柱）、葉（菱形）、花（形状分岐）の全データを単一の`ofVboMesh`で管理し、インデックス参照によりドローコールを最適化。
  * **LOD (Level of Detail)**: 再帰深度に応じて幹のセグメント数（3〜5）を調整。
  * **法線計算**: 頂点ごとに法線（Normal）を設定。`ofLight`による平行光源（SUNNY）および点光源（MOONLIGHT）の陰影計算に対応。
  * **縦方向分割 (Subdivision)**: 1つの枝を縦方向に4分割（5つの断面）して生成。ねじれ (Twist) / テーパリングを表現。
  * **カメラ制御**:
    * 木の推定全高に基づき、注視点（Target）と距離（Distance）を自動計算し補間移動。
    * `settings.json`より回転速度、追従感度の調整が可能。

### **3.3 UI・視覚演出**
* **パラメータバー**: 現在値と最大値（Memory）を一つのバーに重ねて表示。
* **レスポンシブUI**: 基準解像度（1024x768）に対するウィンドウサイズ比率に基づきHUDを自動スケール。
* **3D/2Dパーティクル**:3D/2Dパーティクル: 育成、天候、および進化発生時にそれぞれ独立した物理挙動を持つパーティクルを生成。

## **4\. 外部設定ファイル (settings.json) 仕様**
* **tree**: 最大深度、経験値ベース値/指数、描画スケール、分岐角、各種色彩（RGB/HSB）。
* **camera**: 回転速度、補間速度、最小距離、高さ係数。
* **weather**: 各天候の背景色。
* **game**: 最大日数、スキルポイント付与間隔、コマンドごとの基礎増分値。

## **5\. 次のステップ (Roadmap)**
* **コマンドのGUI化**: ーボード操作をofxButton等による画面上でのマウス操作へ完全移行。
* **CGの改善**: 枝・幹同士のつなぎ目を滑らかにする。
* **UI改善**: 直感的な操作などインタラクションの強化。